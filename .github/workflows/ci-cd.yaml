# .github/workflows/ci-cd.yml
name: Frontend CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  IMAGE_REGISTRY: amdp-registry.skala-ai.com/skala25a
  IMAGE_NAME: sk-team-08-decase-fe
  IMAGE_TAG: 1.0.0

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Clone Repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Generate Hash Code and Image Tag
        id: tag
        run: |
          HASHCODE=$(date +%s%N | sha256sum | cut -c1-12)
          FINAL_IMAGE_TAG="${{ env.IMAGE_TAG }}-${{ github.run_number }}-${HASHCODE}"

          echo "Generated Hash Code: ${HASHCODE}"
          echo "Final Image Tag: ${FINAL_IMAGE_TAG}"

          echo "FINAL_IMAGE_TAG=${FINAL_IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "HASHCODE=${HASHCODE}" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci

      - name: ğŸ§ª Run Tests (Optional)
        run: |
          # npm run test ë˜ëŠ” yarn test
          echo "Tests would run here"

      - name: ğŸ—ï¸ Build Application
        run: |
          npm run build
          echo "âœ… Build completed successfully"

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.IMAGE_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Docker Build & Push
        run: |
          FINAL_TAG="${{ steps.tag.outputs.FINAL_IMAGE_TAG }}"
          FULL_IMAGE_NAME="${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${FINAL_TAG}"

          echo "ğŸ³ Building Docker image: ${FULL_IMAGE_NAME}"

          # Jenkinsì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ Docker ë¹Œë“œ
          docker build --platform linux/amd64 -t "${FULL_IMAGE_NAME}" .

          echo "ğŸ“¤ Pushing Docker image to registry..."
          docker push "${FULL_IMAGE_NAME}"

          echo "âœ… Docker image built and pushed successfully"
          echo "ğŸ“¦ Image: ${FULL_IMAGE_NAME}"

      - name: ğŸ“ Update Deploy.yaml and Git push
        run: |
          echo "ğŸ“ Updating deploy.yaml with new image..."

          NEW_IMAGE_LINE="          image: ${{ secrets.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.FINAL_IMAGE_TAG }}"

          echo "ğŸ”„ New image line: ${NEW_IMAGE_LINE}"

          sed -i 's|^[[:space:]]*image:.*$|'"${NEW_IMAGE_LINE}"'|g' ./k8s/deploy.yaml

          echo "ğŸ“‹ Updated deploy.yaml content:"
          cat ./k8s/deploy.yaml

      - name: ğŸ“¤ Commit and Push Changes
        run: |
          echo "ğŸ“¤ Committing and pushing changes..."

          # Secretsì—ì„œ Git ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          git config user.name "${{ secrets.GIT_USER_NAME }}"
          git config user.email "${{ secrets.GIT_USER_EMAIL }}"

          # deploy.yaml íŒŒì¼ì„ ìŠ¤í…Œì´ì§• ì˜ì—­ì— ì¶”ê°€
          git add ./k8s/deploy.yaml || true

          if ! git diff --cached --quiet; then
            echo "âœ… Changes detected, committing..."
            
            git commit -m "[AUTO] Update deploy.yaml with image ${{ steps.tag.outputs.FINAL_IMAGE_TAG }} [skip ci]"
            
            echo "ğŸ“¤ Pushing to repository..."
            git push origin ${{ env.GIT_BRANCH }}
            
            echo "âœ… Successfully pushed manifest update to repository"
          else
            echo "â„¹ï¸ No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ‰ Frontend CI/CD Pipeline Completed!"
          echo "ğŸ“¦ Docker Image: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.IMAGE_TAG }}"
          echo "ğŸ”„ ArgoCD will automatically sync and deploy this change"
          echo "ğŸŒ Access URL: https://decase.skala25a.project.skala-ai.com"
